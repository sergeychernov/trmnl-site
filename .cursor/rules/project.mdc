## Правила Cursor — проектные (глобальные)

### Коммуникация
- Отвечай кратко на русском. Детали — по запросу.
- Используй заголовки `##/###`, списки `-`, инлайн-код в бэктиках. Ссылки — markdown.
- Показ кода:
  - Существующий код — CODE REFERENCE с диапазоном строк.
  - Новый/предложенный — markdown-блоки с указанием языка.

### Общие договорённости
- Стек: Next.js 15 (App Router, `app/`), React 19, TypeScript (strict), Turbopack.
- Алиасы импортов: `@/*` — абсолютные от корня репозитория.
- Стили: Tailwind v4 по умолчанию; сложные случаи — CSS Modules рядом с компонентом.
- Переменные окружения: локально в `.env.local` (не коммитить). Клиентские — `NEXT_PUBLIC_*`. Добавляй `.env.example` при вводе новых переменных.

### Стиль кода
- TypeScript: явные типы для экспортируемых API. Не использовать `any`.
- Управление потоком: ранние возвраты, избегать глубокой вложенности, минимум try/catch.
- Комментарии: только для неочевидного контекста, инвариантов и оговорённых крайних случаев.
- Форматирование: соблюдать текущий стиль файла, не переоформлять несвязанный код.

### Рабочий процесс
- Малые правки — минимальные диффы, атомарные коммиты (Conventional Commits: `feat:`, `fix:`, `chore:`, `refactor:`).
- В PR описывать цель, ключевые изменения и риск/миграции. Коротко.
- Перед коммитом: линт только изменённых файлов. Исправлять ошибки/варнинги.
- **ВАЖНО: НИКОГДА не использовать git-команды (commit, push, pull и т.д.). Только показывать пользователю, что нужно сделать.**

### Инструменты и команды
- Запуск: `yarn dev`
- Сборка: `yarn build`
- Прод: `yarn start`
- Линт: `yarn lint`

### Диалоги и вывод кода
- Не вставляй «голые» URL; используй бэктики либо markdown-ссылки.
- Для больших кусков кода — показывай только существенные фрагменты, остальное сворачивай комментариями.

### Идентификация пользователей
- ID пользователя системы — это хеш MAC‑адреса устройства.
- Стандартная функция вычисления: `hashMacAddress` из `@lib/hash`.
- Нормализация MAC перед хешированием: верхний регистр, удаление не шестнадцатеричных символов.
- Хеш может вычисляться как на сервере, так и в клиенте; в URL‑сегментах (например, `/settings/[id]`) используется именно этот ID.

### Настройки и плагины
- Структура настроек:
  - Пользователь: `{ name: string; age: number }`
  - Устройство: `{ pluginId: string; pluginSettings: unknown }`
  - Полная модель: `Settings = { user, device }` (см. `@lib/settings`)
- Хранение:
  - Локально на клиенте по ключу `settings:<id>`, где `id` — хеш MAC.
  - В БД: коллекция `settings`, документ с `_id = <id>` (`hash(MAC)`), upsert по `PUT /api/settings/[id]`.
- Выбор плагина:
  - Если записи в `settings` нет — используется плагин `registration` (QR на `/settings/<id>`).
  - Если запись есть — используется `settings.device.pluginId` и его `pluginSettings`.
- Плагины размещаются в `plugins/${pluginName}` и регистрируются в `plugins/index.ts`.
- Контракт плагина (см. `plugins/types.ts`):
  - `id: string`, `name: string`
  - `outputSize: { width: number; height: number }` — фиксированный размер изображения для плагина
  - `defaultSettings: object`
  - `validate(value): value is TSettings` — рантайм‑валидация настроек плагина
  - `render(user, device, context): Promise<MonochromeImage>`
    - `context = { deviceId: string | null; baseUrl: string }`
- Формат изображения `MonochromeImage`:
  - `width`, `height` — пиксели
  - `data: Uint8Array` — 1‑бит на пиксель, упаковано побайтно (MSB→LSB), строка за строкой
- UI страницы `/settings/[id]`:
  - Поля пользователя: имя, возраст
  - Выбор плагина из реестра
  - Редактирование `pluginSettings` в JSON c валидацией через `plugin.validate`

### Устройство TRMNL (BYOS)
- Целевой дисплей: 800×480 px, 1‑бит (монохром), итоговый формат для устройства — BMP.
- Рекомендация по рендеру: плагин возвращает `MonochromeImage` (raw 1‑бит), конвертацию в BMP выполняет серверный API‑роут.
- Ориентация экрана:
  - По умолчанию `landscape`; возможно `portrait` в настройках плагина.
  - Размер `outputSize` плагина остаётся фиксированным, вращение контента — ответственность плагина/рендера.
- Эндпоинты BYOS:
  - `/api/setup` — первичная регистрация устройства (принимает MAC, выдаёт/подтверждает API‑ключ).
  - `/api/display` — отдаёт ссылку на изображение и параметры обновления (sleep/refresh).
  - `/api/log` — сбор логов устройства.
- Ссылка на специфику реализации и формат: см. BYOS Next.js для TRMNL — README (`https://github.com/usetrmnl/byos_next/blob/main/README.md`).


