#!/usr/bin/env node
import path from "node:path";
import { fileURLToPath } from "node:url";
import fs from "node:fs/promises";
import React from "react";
import { renderToStaticMarkup } from "react-dom/server";
import sharp from "sharp";
import { SmileyIcon } from "@phosphor-icons/react/dist/ssr/Smiley";
import { SmileyWinkIcon } from "@phosphor-icons/react/dist/ssr/SmileyWink";
import { HandHeartIcon } from "@phosphor-icons/react/dist/ssr/HandHeart";
import { HeartIcon } from "@phosphor-icons/react/dist/ssr/Heart";
import { SmileyMeltingIcon } from "@phosphor-icons/react/dist/ssr/SmileyMelting";
import { SmileyXEyesIcon } from "@phosphor-icons/react/dist/ssr/SmileyXEyes";
import { SunIcon } from "@phosphor-icons/react/dist/ssr/Sun";
import { SunDimIcon } from "@phosphor-icons/react/dist/ssr/SunDim";

const ICONS = {
	smiley: SmileyIcon,
	"smiley-wink": SmileyWinkIcon,
	"hand-heart": HandHeartIcon,
	heart: HeartIcon,
	"smiley-melting": SmileyMeltingIcon,
	"smiley-xeyes": SmileyXEyesIcon,
	sun: SunIcon,
	"sun-dim": SunDimIcon,
};

async function renderIconToBase64(Icon, size) {
	const element = React.createElement(Icon, { size, weight: "fill", color: "black" });
	const svg = renderToStaticMarkup(element);
	const buffer = await sharp(Buffer.from(svg)).resize(size, size).png().toBuffer();
	return buffer.toString("base64");
}

async function main() {
	const size = 256;
	const entries = [];
	for (const [name, Icon] of Object.entries(ICONS)) {
		const base64 = await renderIconToBase64(Icon, size);
		entries.push([name, base64]);
	}
	const lines = [];
	lines.push("// Auto-generated by scripts/gen-hello-icons.mjs");
	lines.push("// Do not edit manually.");
	lines.push("");
	lines.push("export const HELLO_ICON_IMAGES = {");
	for (const [name, base64] of entries) {
		lines.push(`\t"${name}": "data:image/png;base64,${base64}",`);
	}
	lines.push("} as const;");
	lines.push("");
	lines.push("export type HelloIconName = keyof typeof HELLO_ICON_IMAGES;");
	lines.push("");
	const __filename = fileURLToPath(import.meta.url);
	const __dirname = path.dirname(__filename);
	const outPath = path.join(__dirname, "../plugins/hello/icon-images.ts");
	await fs.writeFile(outPath, lines.join("\n"), "utf8");
	console.log(`Generated ${entries.length} icons into ${outPath}`);
}

main().catch((err) => {
	console.error(err);
	process.exit(1);
});


